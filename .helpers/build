#!/bin/bash
source "${0%/*}/util.sh"
shopt -s nullglob
shopt -s extglob

base=$(realpath "${0%/*}/..")

pkgbase="$(basename "$PWD")"
sha()
{
	sha256sum "$1" | awk '{print $1}'
}

NOBUILDOPTS=$(
	grep BUILDPKG=0 /usr/bin/makepkg \
		| cut -d\) -f1 \
		| awk '{print $1}' \
		| tr '|' '\n'
)

NOBUILDOPTS="--($(
	awk -F - '/^--/{printf $3"|"}' <<< "$NOBUILDOPTS" \
		| sed 's/|$/\n/'
))|-[^-]*($(
	awk -F - '/^-/ && ! /^--/ {printf $2"|"}' <<< "$NOBUILDOPTS" \
		| sed 's/|$/\n/'
)).*"

if [[ -d "$base/$pkgbase" && "$PWD" != "$base/$pkgbase" && ! -f .rsynced ]]; then
	rsync --stderr=all -aqz "$base/$pkgbase/" . >&2
	touch .rsynced
fi

if ! grep -q -- '--config '"$HOME"'/makepkg.conf' <<< "$*"; then
	set -- --config ~/makepkg.conf "$@"
fi
export SRCDEST="${REPO_PREFIX}/pkgs/src/$pkgbase"

if printf '%s\n' "$@" \
	| grep -qE -- '^('"$NOBUILDOPTS"')$'; then
	exec makepkg "$@"
fi

# Override pkgrel
"${0%/*}/maint/pkgrel"

# Build package
dbug 'Building pkgbase: %s' "$pkgbase"
makepkg --nocheck "$@"
ret=$?

if [[ -f .rsynced ]]; then
	rm .rsynced
fi

# Update meta info
if ((ret == 0 || ret == 13)); then
	if ((ret == 13)); then
		ret=0
	fi
	makepkg --config ~/makepkg.conf --packagelist 2> /dev/null >> "$base/pkgs.txt"

	info 'Checking built packages'
	makepkg --config ~/makepkg.conf --packagelist 2> /dev/null \
		| xargs -r -d $'\n' -n 1 env "PKGDEST=$(
			source ~/makepkg.conf
			echo "$PKGDEST"
		)" testpkg >&2
	((ret += $?))

	makepkg --config ~/makepkg.conf --printsrcinfo 2> /dev/null \
		| awk '/pkgname/{print $3}' >> "$base/ipc"
	((ret += $?))
else
	fail 'file=%s' 'Failed to build: %s' "$PWD/PKGBUILD" "$pkgbase"
fi

exit $ret
