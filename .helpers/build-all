#!/bin/bash -e
source "${0%/*}/util.sh"

shopt -s nullglob
shopt -s extglob

built=()
base=$(realpath "${0%/*}/..")
helpers="$base/.helpers"

cd "$base" || exit 1

truncate -s 0 pkgs.txt ipc

for each in */; do
	unset pkgs pkgbase
	truncate -s 0 ipc

	pkgbase=$(basename "$each")
	[[ -f $pkgbase/PKGBUILD ]] || continue
	if grep -xqF "$pkgbase" "$base/buildignore"; then
		warn 'file=buildignore' 'Skip building %s' "$pkgbase"
		continue
	else
		printf "::group::${GREEN}${BOLD}Build %s${ALL_OFF}\n" "$pkgbase"
	fi
	pushd "$pkgbase" || {
		fail 'file=%s,line=25' 'Failed to change directory: %s' "$0" "$pkgbase"
		printf '::endgroup::\n' >&2
		continue
	}

	if "$helpers/maint/deps"; then # Get dependencies
		if "$helpers/build"; then # Build package
			readarray -t pkgs < "$base/ipc"
			built+=("${pkgs[@]}")
			dbug 'Built package: %s' "${pkgs[@]}"
		else
			fail 'file=%s,line=34' 'Failed to build: %s' "$0" "$pkgbase"
		fi
	else
		fail 'file=%s,line=32' 'Failed to install dependencies of: %s' "$0" "$pkgbase"
	fi
	"$helpers/maint/deps" --clean
	popd || :
	printf '::endgroup::\n'
done

# Sort the prune whitelist
sort -u < "$base/pkgs.txt" > "$base/pkgs.txt~" && mv "$base/pkgs.txt"{~,}
